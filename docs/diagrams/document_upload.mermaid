sequenceDiagram
    autonumber

    actor Admin
    participant Gateway as API Gateway
    participant Corpus as Corpus Service
    participant NATS
    participant Indexing as Indexing Service
    participant Ollama
    participant PG as PostgreSQL (pgvector)
    participant Qdrant as Qdrant

    Admin->>Gateway: POST /api/v1/documents\n(upload MD file)
    Gateway->>Gateway: Validate JWT & Role
    Gateway->>Corpus: Forward request

    Corpus->>PG: INSERT INTO documents
    PG-->>Corpus: document_id, version=1

    Corpus->>PG: INSERT INTO document_versions

    Corpus->>NATS: Publish:\ncorpus.document.created\n{document_id, content, metadata}

    Corpus-->>Gateway: 201 Created\n{document_id}
    Gateway-->>Admin: Success Response

    Note over NATS,Indexing: Async Processing Starts

    NATS->>Indexing: Event: corpus.document.created

    Indexing->>PG: SELECT content FROM documents
    PG-->>Indexing: document content

    Indexing->>Indexing: Split into chunks\n(~1000 tokens, 100 overlap)

    loop For each chunk
        Indexing->>Ollama: POST /api/embeddings\n{model: nomic-embed-text}
        Ollama-->>Indexing: embedding vector (768d)
        Indexing->>Qdrant: Upsert vector\n(document_id, chunk_id, embedding, metadata)
    end

    Indexing->>Qdrant: Commit / Ensure indexed
    Qdrant-->>Indexing: OK

    Indexing->>NATS: Publish:\nindexing.document.indexed\n{document_id, chunks_count}

    NATS->>Corpus: Event: indexing.document.indexed
    Corpus->>PG: UPDATE documents\nSET indexed=true

    Note over Admin,PG: Document ready for RAG queries