graph TB
    A["ðŸ‘¤ User Request"] -->|"POST /api/v1/chat"| B["ðŸ”— HTTP Handler"]
    B -->|"ProcessInput(userID, input)"| C["ðŸ¤– Chat Service"]

    C -->|"1. Retrieve History"| D["ðŸ’¾ Redis Store"]
    D -->|"chat:history:userID"| D

    C -->|"2. Save User Message"| D
    D -->|"Append to history"| D

    C -->|"3. Generate Embeddings"| E["ðŸ§  Neuro Connector\n(Ollama)"]
    C -->|"4. Retrieve Documents"| F["ðŸ“š Vector Store\n(Qdrant)"]

    E -->|"Chat with Context"| G["ðŸ”„ Stream Response\nChunks"]

    G -->|"Chunk 1"| H["Chunk Handler"]
    G -->|"Chunk 2..N"| H
    G -->|"Chunk N (done=true)"| H

    H -->|"Buffer"| I["ðŸ’¾ Redis Temp\nchat:temp_msg:userID"]
    H -->|"Save Full Message\n(when done)"| D
    H -->|"Stream to Client"| J["ðŸ“¡ Response Stream\nNDJSON"]

    D -->|"âœ… TTL: 24h"| K["Auto-Expiration"]
    I -->|"âœ… TTL: 24h"| K

    L["ðŸ§¹ Delete Chat\nDELETE /api/v1/chat/userID"] -->|"Clear Both"| D
    L --> I

    style A fill:#e1f5ff
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9
    style E fill:#fce4ec
    style F fill:#f1f8e9
    style G fill:#ede7f6
    style H fill:#fff9c4
    style I fill:#e0f2f1
    style J fill:#e0f2f1
    style K fill:#ffebee
    style L fill:#ffccbc

