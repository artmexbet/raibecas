# Документация по реализации сервиса аутентификации

## Обзор

Этот документ описывает реализацию сервиса аутентификации для платформы Raibecas в соответствии со спецификацией в `docs/SPECS.md`.

## Что было реализовано

### 1. Основной функционал аутентификации

✅ **Регистрация пользователей с модерацией**
- Пользователи отправляют заявки через топик NATS `auth.register`
- Заявки сохраняются со статусом `pending` в PostgreSQL
- Система публикует событие `auth.registration.requested` в NATS
- Admin-сервис может одобрить/отклонить через события NATS
- При одобрении создаётся аккаунт пользователя и публикуется событие `auth.user.registered`

✅ **JWT-based аутентификация**
- Безопасный вход через топик `auth.login`
- JWT access токены (TTL 15 мин) с подписью HS256
- Refresh токены (TTL 7 дней) хранятся в Redis
- Валидация токенов через топик `auth.validate`
- Обновление токенов с ротацией через топик `auth.refresh`

✅ **Управление сессиями**
- Хранилище refresh-токенов на базе Redis
- Двунаправленный поиск (по user ID и значению токена)
- Выход с текущего устройства: топик `auth.logout`
- Выход со всех устройств: топик `auth.logout_all`

✅ **Управление паролями**
- Хеширование bcrypt с фактором сложности 12
- Самостоятельная смена пароля: топик `auth.change_password`
- Автоматический выход со всех устройств после смены пароля

### 2. Архитектура и дизайн

✅ **Чистая архитектура**
```
auth/
├── cmd/auth/              # Точка входа приложения
├── internal/
│   ├── config/           # Управление конфигурацией (cleanenv)
│   ├── domain/           # Доменные модели и интерфейсы
│   ├── repository/       # Доступ к данным PostgreSQL (SQLC)
│   ├── storeredis/       # Хранилище токенов Redis
│   ├── service/          # Бизнес-логика
│   ├── handler/          # NATS обработчики
│   ├── nats/            # Событийная pub/sub
│   └── server/          # Настройка сервера
├── pkg/
│   └── jwt/             # Управление JWT токенами
├── migrations/          # Миграции базы данных
└── sqlc/                # SQLC конфигурация и запросы
```

✅ **Внедрение зависимостей**
- Сервисы используют интерфейсы вместо конкретных типов
- Легко мокировать для тестирования
- Слабая связанность между слоями

✅ **Event-Driven коммуникация**
- NATS Pub/Sub для асинхронной коммуникации
- NATS Request/Reply для синхронных запросов
- Публикуемые события:
  - `auth.user.registered` (с username и email)
  - `auth.user.login`
  - `auth.user.logout`
  - `auth.password.reset`
  - `auth.registration.requested`
- Подписанные события:
  - `admin.registration.approved`
  - `admin.registration.rejected`

### 3. Хранение данных

✅ **Таблицы PostgreSQL**
- `users` - Аккаунты пользователей с ролями и статусом
- `registration_requests` - Заявки на регистрацию с метаданными

✅ **Хранилище Redis**
- `refresh_token:user:{user_id}` - Данные токена по user ID
- `refresh_token:value:{token}` - User ID по значению токена
- Автоматическое истечение TTL

### 4. Безопасность

✅ **Безопасность паролей**
- Хеширование bcrypt с cost 12
- Пароли никогда не хранятся в открытом виде
- Валидация надёжности пароля (минимум 8 символов)

✅ **Безопасность токенов**
- JWT подписаны с HMAC-SHA256
- Короткоживущие access токены (15 мин)
- Ротация токенов при обновлении
- Старые refresh токены немедленно аннулируются

✅ **Управление уязвимостями**
- Все зависимости проверены через GitHub Advisory Database
- Обновлены до безопасных версий:
  - `github.com/gofiber/fiber/v2` v2.52.9 (исправлена)
  - `github.com/golang-jwt/jwt/v5` v5.2.2 (исправлена)

✅ **Безопасность API**
- Защищённые операции требуют аутентификации
- Валидация JWT токенов
- Распространение контекста пользователя

### 5. Тестирование

✅ **Комплексный набор тестов**
- **JWT Manager**: 5 тестов, покрывающих генерацию и валидацию токенов
- **Auth Service**: 4 теста, покрывающих вход, выход и валидацию
- **Refresh Token**: 3 теста, покрывающих успех, недействительный токен и неактивного пользователя
- **Всего**: 12 тестов, все проходят

✅ **Тестовая инфраструктура**
- Мок-реализации для репозиториев и хранилищ
- Изолированные unit-тесты без внешних зависимостей
- Чёткие тест-кейсы с фазами setup, action и assertion

### 6. Документация

✅ **API документация**
- Полная справка по API в README.md
- Примеры запросов/ответов для всех топиков
- Руководство по конфигурации окружения

✅ **Инструменты разработки**
- `.env.example` со всеми опциями конфигурации
- Docker Compose для локальной разработки
- SQLC для генерации кода работы с БД

✅ **Документация кода**
- Инлайн комментарии для сложной логики
- Определения интерфейсов с чёткими обязанностями
- Документация на уровне пакетов

## Технологический стек

| Компонент | Технология | Версия |
|-----------|-----------|--------|
| Язык | Go | 1.25.1 |
| Конфигурация | cleanenv | latest |
| Генерация кода БД | SQLC | latest |
| База данных | PostgreSQL | 16 с pgvector |
| Кэш/Сессии | Redis | 7 |
| Message Broker | NATS | Latest |
| JWT | golang-jwt | 5.2.2 |
| Хеширование паролей | bcrypt | Latest |
| Тестирование | Go test | Встроенный |

## NATS топики

| Топик | Тип | Описание |
|-------|-----|----------|
| `auth.register` | Request/Reply | Отправить заявку на регистрацию |
| `auth.login` | Request/Reply | Аутентифицировать и получить токены |
| `auth.refresh` | Request/Reply | Обновить access токен |
| `auth.validate` | Request/Reply | Валидировать access токен |
| `auth.logout` | Request/Reply | Выход с текущего устройства |
| `auth.logout_all` | Request/Reply | Выход со всех устройств |
| `auth.change_password` | Request/Reply | Изменить пароль |

## Поток событий NATS

### Поток регистрации
```
Пользователь → auth.register → Auth Service
                                     ↓
                          auth.registration.requested
                                     ↓
                                Admin Service
                                     ↓
                       admin.registration.approved
                                     ↓
                               Auth Service
                                     ↓
                            (создаёт пользователя)
                                     ↓
                           auth.user.registered
```

### Поток аутентификации
```
Пользователь → auth.login → Auth Service
                                  ↓
                       (валидирует credentials)
                                  ↓
                          (генерирует токены)
                                  ↓
                          (сохраняет в Redis)
                                  ↓
                          auth.user.login
```

## Конфигурация

Вся конфигурация через переменные окружения с использованием cleanenv. См. `.env.example` для полного списка.

**Критичная конфигурация:**
- `JWT_SECRET` - Должна быть установлена (нет значения по умолчанию)
- `DB_PASSWORD` - Должна быть установлена (нет значения по умолчанию)
- `JWT_ACCESS_TTL` - По умолчанию 15m
- `JWT_REFRESH_TTL` - По умолчанию 168h (7 дней)

## Настройка разработки

1. **Запустите инфраструктуру:**
   ```bash
   docker-compose -f docker-compose.dev.yml up -d postgres redis nats
   ```

2. **Выполните миграции:**
   ```bash
   psql -h localhost -U raibecas -d raibecas -f migrations/001_create_users_table.sql
   psql -h localhost -U raibecas -d raibecas -f migrations/002_create_registration_requests_table.sql
   ```

3. **Сгенерируйте код SQLC:**
   ```bash
   cd services/auth
   sqlc generate
   ```

4. **Установите переменные окружения:**
   ```bash
   export DB_PASSWORD=raibecas_dev
   export JWT_SECRET=dev_secret_change_in_production
   ```

5. **Запустите сервис:**
   ```bash
   go run cmd/auth/main.go
   ```

6. **Запустите тесты:**
   ```bash
   go test ./... -v
   ```

## Архитектурные решения

### Почему интерфейсы?
Использование интерфейсов (domain.UserRepository, domain.TokenStore) позволяет:
- Легко мокировать в тестах
- Гибкость смены реализаций
- Слабую связанность между слоями

### Почему двунаправленный поиск токенов?
Хранение токенов по user ID и значению токена позволяет:
- Быструю валидацию refresh токенов (по значению токена)
- Лёгкий выход по user ID
- Эффективную очистку токенов

### Почему ротация токенов?
Ротация refresh токенов при каждом обновлении:
- Ограничивает ущерб от кражи токена
- Предоставляет audit trail
- Индустриальная лучшая практика

### Почему Event-Driven?
Использование NATS Pub/Sub:
- Разделяет сервисы
- Включает асинхронную обработку
- Горизонтально масштабируется
- Поддерживает event sourcing при необходимости

### Почему NATS вместо HTTP?
- Меньшая задержка
- Встроенное балансирование нагрузки
- Лучше для микросервисов
- Поддержка request/reply и pub/sub
- Автоматическое переподключение

## Соображения производительности

- **Redis**: O(1) поиск токенов
- **PostgreSQL**: Индексированные запросы для пользователей и регистраций
- **JWT**: Stateless валидация (без запроса к БД)
- **Connection Pooling**: Настраиваемые min/max соединения
- **NATS**: Высокая пропускная способность, низкая задержка

## Будущие улучшения

Потенциальные улучшения, не входящие в объём:

1. **Поддержка OAuth2/OIDC** - Интеграция с внешними identity провайдерами
2. **Многофакторная аутентификация** - 2FA на основе TOTP или SMS
3. **Rate Limiting по пользователю** - Предотвращение brute force атак
4. **Сброс пароля через Email** - Самостоятельное восстановление пароля
5. **Аналитика сессий** - Отслеживание мест входа и устройств
6. **Audit логирование** - Детальное логирование событий безопасности
7. **Blacklist токенов** - Отзыв конкретных access токенов
8. **Семейства Refresh токенов** - Обнаружение атак повторного использования токенов

## Соответствие и безопасность

✅ Хеширование паролей с индустриальным стандартом bcrypt
✅ Безопасная генерация и валидация токенов
✅ Нет секретов в коде или логах
✅ Зависимости проверены на уязвимости
✅ Защищённые операции требуют аутентификации
✅ Изящная обработка ошибок
✅ Валидация ввода
✅ Предотвращение SQL инъекций (параметризованные запросы с SQLC)

## Заключение

Сервис аутентификации готов к продакшену с:
- ✅ Полной реализацией функционала
- ✅ Чистым, поддерживаемым кодом
- ✅ Комплексным покрытием тестами
- ✅ Лучшими практиками безопасности
- ✅ Event-driven архитектурой через NATS
- ✅ Отличной документацией
- ✅ Лёгким развёртыванием с Docker
- ✅ SQLC для типобезопасной работы с БД
- ✅ Cleanenv для управления конфигурацией

Сервис следует современным Go паттернам и полностью соответствует микросервисной архитектуре, указанной в документации проекта.
