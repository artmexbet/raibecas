sequenceDiagram
    actor User
    participant Gateway as Client/Gateway
    participant NATS as NATS Broker
    participant AuthHandler as Auth Handler
    participant AuthService as Auth Service
    participant JWT as JWT Manager
    participant Cache as Redis
    participant Events as Event Publisher
    participant OtherServices as Other Services

    User->>Gateway: Нажимает кнопку "Выход"
    Gateway->>NATS: Публикует auth.logout запрос
    NATS->>AuthHandler: Получает auth.logout

    AuthHandler->>AuthService: ValidateAccessToken(token)
    AuthService->>JWT: Validate(token)
    JWT-->>AuthService: Возвращает claims с user_id
    AuthService-->>AuthHandler: Возвращает claims

    alt Токен невалиден
        AuthHandler-->>NATS: Отправляет ошибку "Unauthorized"
        NATS-->>Gateway: Возвращает ошибку
        Gateway-->>User: Ошибка (токен истёк)

    else Токен валиден, но user_id не совпадает
        AuthHandler-->>NATS: Отправляет ошибку "Unauthorized"
        NATS-->>Gateway: Возвращает ошибку
        Gateway-->>User: Ошибка (несоответствие)

    else Токен валиден и user_id совпадает
        AuthHandler->>AuthService: Logout(user_id, token)

        AuthService->>Cache: GET refresh_token:value:{token}
        Cache-->>AuthService: Возвращает user_id и device_id

        AuthService->>Cache: DELETE refresh_token:value:{token}
        Cache-->>AuthService: ОК (удалён value индекс)

        AuthService->>Cache: DELETE refresh_token:user:{user_id}:{device_id}
        Cache-->>AuthService: ОК (удалена основная запись)

        AuthService-->>AuthHandler: Возвращает успех

        AuthHandler->>Events: PublishUserLogout(user_id, timestamp)
        Events->>NATS: Публикует auth.user.logout
        NATS->>OtherServices: Рассылает событие logout
        OtherServices-->>OtherServices: Обрабатывают событие выхода

        AuthHandler->>NATS: Отправляет успешный ответ
        NATS-->>Gateway: Возвращает {success: true, message: "Logged out successfully"}
        Gateway-->>User: Успешно вышли
    end

