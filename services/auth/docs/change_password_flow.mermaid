C4Component
    title Смена пароля (ChangePassword)

    Container_Ext(client, "Client/Gateway", "Go, Fiber", "Запрашивает смену пароля")
    ContainerDb(changePasswordTopic, "auth.change_password", "NATS", "Request/Reply")

    Container_Boundary(authService, "Auth Service") {
        Component(authHandler, "Auth Handler", "Go, NATS Handler", "Обрабатывает запрос на смену пароля")
        Component(authService_comp, "Auth Service", "Business Logic", "Обновляет пароль и выполняет выход со всех устройств")
        Component(jwtMgr, "JWT Manager", "Token Validation", "Валидирует access токен")
        Component(passwordMgr, "Password Manager", "Security", "Хеширует новый пароль (bcrypt)")
        ContainerDb(userDB, "PostgreSQL users", "Database", "Обновляет хеш пароля")
    }

    ContainerDb(redis, "Redis", "Session Storage", "Удаляет все refresh токены пользователя")
    ContainerDb(passwordResetTopic, "auth.password.reset", "NATS", "Event")
    Container_Ext(otherServices, "Other Services", "Microservices", "Получают события смены пароля")

    Rel(client, changePasswordTopic, "POST: {user_id, token, old_password, new_password}", "Request/Reply")
    Rel(changePasswordTopic, authHandler, "Subscribe", "Handle request")
    Rel(authHandler, authService_comp, "ValidateAccessToken()", "Verify token")
    Rel(authService_comp, jwtMgr, "Validate(token)", "Parse & Verify")
    Rel(jwtMgr, authService_comp, "Return claims", "Response")
    Rel(authHandler, authService_comp, "ChangePassword(request)", "Call")
    Rel(authService_comp, userDB, "SELECT user by id", "Get current password hash")
    Rel(userDB, authService_comp, "Return user", "Response")
    Rel(authService_comp, passwordMgr, "VerifyPassword(old_password)", "Validate old password")
    Rel(authService_comp, passwordMgr, "HashPassword(new_password)", "Hash new password")
    Rel(authService_comp, userDB, "UPDATE user.password_hash", "Save new password")
    Rel(authService_comp, redis, "DELETE refresh_token:user:{user_id}:*", "Invalidate all sessions")
    Rel(authHandler, passwordResetTopic, "Publish event", "Event: {user_id, method: 'self-service', timestamp}")
    Rel(passwordResetTopic, otherServices, "Subscribe", "Handle password change event")
    Rel(authHandler, changePasswordTopic, "RESPONSE: {success: true, message}", "Reply")

