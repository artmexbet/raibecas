sequenceDiagram
    actor User
    participant Gateway as Client/Gateway
    participant NATS as NATS Broker
    participant AuthHandler as Auth Handler
    participant AuthService as Auth Service
    participant JWT as JWT Manager
    participant PasswordMgr as Password Manager
    participant DB as PostgreSQL
    participant Cache as Redis
    participant Events as Event Publisher
    participant OtherServices as Other Services

    User->>Gateway: Отправляет старый и новый пароль
    Gateway->>NATS: Публикует auth.change_password запрос
    NATS->>AuthHandler: Получает auth.change_password

    AuthHandler->>AuthService: ValidateAccessToken(token)
    AuthService->>JWT: Validate(token)
    JWT-->>AuthService: Возвращает claims с user_id
    AuthService-->>AuthHandler: Возвращает claims

    alt Токен невалиден
        AuthHandler-->>NATS: Отправляет ошибку "Unauthorized"
        NATS-->>Gateway: Возвращает ошибку
        Gateway-->>User: Ошибка (токен истёк)

    else Токен валиден, но user_id не совпадает
        AuthHandler-->>NATS: Отправляет ошибку "Unauthorized"
        NATS-->>Gateway: Возвращает ошибку
        Gateway-->>User: Ошибка (несоответствие)

    else Токен валиден и user_id совпадает
        AuthHandler->>AuthService: ChangePassword(user_id, old_password, new_password)

        AuthService->>DB: SELECT user WHERE id = user_id
        DB-->>AuthService: Возвращает пользователя с password_hash

        AuthService->>PasswordMgr: VerifyPassword(old_password, password_hash)

        alt Старый пароль неверный
            PasswordMgr-->>AuthService: Возвращает false
            AuthService-->>AuthHandler: Возвращает ошибку "Invalid old password"
            AuthHandler->>NATS: Отправляет ошибку
            NATS-->>Gateway: Возвращает ошибку
            Gateway-->>User: Ошибка (неверный старый пароль)

        else Старый пароль верный
            AuthService->>PasswordMgr: HashPassword(new_password, cost=12)
            PasswordMgr-->>AuthService: Возвращает new_password_hash

            AuthService->>DB: UPDATE users SET password_hash = ? WHERE id = ?
            DB-->>AuthService: ОК (пароль обновлён)

            AuthService->>Cache: SCAN refresh_token:user:{user_id}:*
            Cache-->>AuthService: Возвращает список всех device_id

            loop Для каждого device_id пользователя
                AuthService->>Cache: GET refresh_token:user:{user_id}:{device_id}
                Cache-->>AuthService: Возвращает token_value

                AuthService->>Cache: DELETE refresh_token:user:{user_id}:{device_id}
                Cache-->>AuthService: ОК

                AuthService->>Cache: DELETE refresh_token:value:{token_value}
                Cache-->>AuthService: ОК
            end

            AuthService-->>AuthHandler: Возвращает успех

            AuthHandler->>Events: PublishPasswordReset(user_id, method='self-service', timestamp)
            Events->>NATS: Публикует auth.password.reset
            NATS->>OtherServices: Рассылает событие смены пароля
            OtherServices-->>OtherServices: Обрабатывают событие (уведомляют пользователя)

            AuthHandler->>NATS: Отправляет успешный ответ
            NATS-->>Gateway: Возвращает {success: true, message: "Password changed successfully"}
            Gateway-->>User: Пароль изменён, вы разлогинены везде
        end
    end

